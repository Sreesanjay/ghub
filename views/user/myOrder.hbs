<style>
    @media only screen and (max-width: 900px) {
        .progress {
            display: none;
        }
    }
</style>
<div class="my-address p-3">
    <h3 class="mb-3">My Orders</h3>
    <div class="my-order-wraper">
        {{#each orders}}
        <div class="card mt-3 p-3 c-pointer">

            <div class="img-container row">
                <img src="/Images/Products/{{this.prod_details.primary_img.filename}}" alt="" class="col-12 col-md-2"
                    style="height: 100px;width:auto;">
                <div class="prod-details col-12 col-md-5 mt-3 mt-md-0">
                    <h5 class="prod-name">{{this.prod_details.product_name}}{{this.prod_details.prod_highlight}}</h5>
                    <h6 class="">{{this.prod_details.brand_name}}</h6>
                </div>
                <div class="price col-12 col-md-2">
                    <h5 id="price">â‚¹{{subtract this.products.price this.products.discount}}</h5>
                </div>
                <div class="status-details col-12 col-md-3">
                    {{#isEqual this.products.status "Payment pending"}}
                    <p class="text-secondary">Payment Pending</p>
                    {{/isEqual}}
                    {{#isEqual this.products.status "Confirmed"}}
                    <p class=""> Confirmed on {{toDate this.products.confirmed_date}}</p>
                    {{/isEqual}}

                    {{#isEqual this.products.status "Shipped"}}
                    <p class=""> Shipped on {{toDate this.products.shipped_date}}</p>
                    {{/isEqual}}

                    {{#isEqual this.products.status "Out for delivery"}}
                    <p class=""> Out for delivery</p>
                    {{/isEqual}}

                    {{#isEqual this.products.status "Delivered"}}
                    <p class="text-success"> Delivered on {{toDate this.products.delivered_date}}</p>
                    {{/isEqual}}

                    {{#isEqual this.products.status "Canceled"}}
                    <p class="text-danger"> Cancelled on {{toDate this.products.cancelled_date}}</p>
                    {{/isEqual}}
                </div>
                <button class="btn text-primary pe-4 mt-3 pb-2" style="width: max-content;"
                    onclick="trackOrder('{{this._id}}{{this.prod_details._id}}')">Track Order
                    <i class="fa-solid fa-chevron-down col-1 fs-5 down-{{this._id}}{{this.prod_details._id}}"></i>
                    <i class="fa-solid fa-chevron-up col-1 fs-5 up-{{this._id}}{{this.prod_details._id}}"
                        style="display: none"></i>
                </button>
            </div>

            <div class="view-order p-3 track-{{this._id}}{{this.prod_details._id}}" style="display:none;">
                <hr>
                {{#isEqual this.products.status "Delivered"}}
                <div class="float-end">
                    <a href="/order/print-invoice?orderid={{this._id}}&product={{this.prod_details._id}}"
                        class="btn btn-success me-1"><i class="fa fa-print"></i></a>
                </div>
                {{/isEqual}}
                <div class="delivery-address">
                    <h6 class="fw-bold"> Delivery Address</h6>
                    <p class="fw-bold">{{this.delivery_address.user_name}}</p>
                    <p>{{this.delivery_address.area_street}}, Near {{this.delivery_address.landmark}},
                        {{this.delivery_address.locality}},
                        {{this.delivery_address.town}},
                        {{this.delivery_address.state}},
                        {{this.delivery_address.pincode}}
                    </p>
                    <p>
                        {{this.delivery_address.phone}},
                        {{this.delivery_address.alternate_phone}}
                    </p>
                </div>

                <div class="row d-flex justify-content-center align-items-center h-100">
                    <div class="col">
                        <div class="card card-stepper" style="border-radius: 10px;">
                            <div class="card-body p-4">

                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex flex-column">
                                        <span class="lead fw-normal">Your order has been {{this.products.status}}</span>
                                    </div>
                                </div>
                                <hr class="my-4">

                                <div
                                    class="d-flex flex-row justify-content-between align-items-center align-content-center">

                                    <div class="col-md-12">
                                        <div class="progress" style="height: 6px; border-radius: 16px;">

                                            <div class="progress-bar" role="progressbar"
                                                style="border-radius: 16px; background-color: #008714;"
                                                aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"
                                                id="bar-{{this._id}}{{this.prod_details._id}}"></div>

                                            <input type="hidden" name="status"
                                                id="{{this._id}}{{this.prod_details._id}}"
                                                value="{{this.products.status}}">

                                        </div>

                                        <div class="d-flex flex-column flex-md-row justify-content-between">
                                            <div class="d-flex flex-md-column align-items-start ">
                                                {{#if this.products.confirmed_date}}
                                                <span>{{toDate this.products.confirmed_date}}</span><span
                                                    class="ms-2 ms-md-0">Confirmed</span>
                                                {{else}}
                                                <span class="text-muted">Confirmed</span>
                                                {{/if}}
                                            </div>

                                            <div class="d-flex flex-md-column align-items-start ">
                                                {{#if this.products.shipped_date}}
                                                <span>{{toDate this.products.shipped_date}}</span><span
                                                    class="ms-2 ms-md-0">Shipped</span>
                                                {{else}}
                                                <span class="text-muted">Shipped</span>
                                                {{/if}}
                                            </div>

                                            {{#if this.products.out_for_delivery_date}}
                                            <div class="d-flex flex-md-column align-items-start ">
                                                <span>{{toDate this.products.out_for_delivery_date}}</span><span
                                                    class="ms-2 ms-md-0">Out
                                                    For
                                                    Delivery</span>
                                            </div>
                                            {{else}}
                                            <span class="text-muted">Out For Delivery</span>
                                            {{/if}}

                                            {{#isEqual this.products.status "Canceled"}}
                                            <div class="d-flex flex-md-column align-items-start">
                                                <div class="d-flex flex-column align-items-end">
                                                    <span>{{toDate
                                                        this.products.cancelled_date}}</span><span
                                                        class="ms-2 ms-md-0">Canceled</span>
                                                </div>
                                            </div>
                                            {{else}}
                                            {{#if this.products.delivered_date}}
                                            <div class="d-flex flex-md-column align-items-start">
                                                <span>{{toDate
                                                    this.products.delivered_date}}</span><span
                                                    class="ms-2 ms-md-0">Delivered</span>
                                            </div>
                                            {{else}}
                                            <span class="text-muted">Delivered</span>
                                            {{/if}}
                                            {{/isEqual}}
                                        </div>
                                        {{#if this.products.out_for_delivery_date}}
                                        {{else}}
                                        {{#isEqual this.products.status "Canceled"}}
                                        {{else}}
                                        <button class="btn btn-outline-danger mt-2 order-cancel">Cancel order
                                        </button><br>
                                        <div class="reason-wraper" style="display: none;">
                                            <textarea name="cancel_reason" class="form-control" id="reason{{this._id}}{{this.prod_details._id}}" cols="30"
                                            rows="5"></textarea>
                                            <button class="btn btn-outline-danger mt-3 clear-cancel">Cancel</button>
                                            <button class="btn btn-outline-primary ms-2 mt-3"
                                                onclick="cancelOrder(event,'{{this._id}}','{{this.prod_details._id}}')">Submit
                                            </button>
                                        </div>
                                        {{/isEqual}}
                                        {{/if}}
                                        {{#isEqual this.products.status "Canceled"}}
                                            <h6 class="mt-3 fw-bold">Calcellation reason</h6>
                                            {{this.products.cancel_reason}}
                                        {{/isEqual}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {{/each}}
    </div>
</div>

<script>
    $(function () {
        const status = document.getElementsByName('status')
        const progressBar = document.getElementById('progress-bar')
        for (let st of status) {
            if (st.value == 'Confirmed') {
                document.getElementById('bar-' + st.id).style.width = '5%'
            }
            else if (st.value == 'Shipped') {
                document.getElementById('bar-' + st.id).style.width = '35%'
            }
            else if (st.value == 'Out for delivery') {
                document.getElementById('bar-' + st.id).style.width = '65%'
            }
            else if (st.value == 'Delivered') {
                document.getElementById('bar-' + st.id).style.width = '100%'
            }
            else if (st.value == 'Canceled') {
                document.getElementById('bar-' + st.id).style.width = '100%'
                document.getElementById('bar-' + st.id).style.backgroundColor = "red";
            }
        }

        trackOrder = (cls) => {

            $('.track-' + cls).slideToggle()
            $('.up-' + cls).toggle()
            $('.down-' + cls).toggle()
        }
        /*cancel order*/

        $('.order-cancel').on('click', () => {
            $('.order-cancel').toggle();
            $('.reason-wraper').slideToggle()
        });
        
        $('.clear-cancel').on('click', () => {
            $('.order-cancel').toggle();
            $('.reason-wraper').slideToggle()
        });

        cancelOrder = (e, order, product) => {
            e.preventDefault()
            Swal.fire({
                title: 'Are you sure',
                text: "You want to cancel the order?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const cancel_reason = document.getElementById('reason'+order+product).value
                    let body={
                        order,
                        product,
                        cancel_reason
                    }
                    fetch('/order/cancel-order',{
                        method:'POST',
                        body:JSON.stringify(body),
                        headers: { "Content-Type": "application/json" }
                    }).then((response) => {
                        return response.json()
                    }).then((data) => {
                        if (data.status == 'success') {
                            Swal.fire(
                                "Success!",
                                "Order Cancelled Successfully",
                                "success"
                            ).then(() => {
                                location.assign("/account/my-orders");
                            });
                        }
                    })
                }
            })
        }
    })
</script>